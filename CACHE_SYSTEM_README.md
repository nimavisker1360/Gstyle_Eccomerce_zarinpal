# ุณุณุชู ฺฉุด ูุญุตููุงุช

## ุฎูุงุตู

ุงู ุณุณุชู ฺฉุด ููุดููุฏ ุจุฑุง ูุฏุฑุช ูุญุตููุงุช ุฏุฑ ุฏุชุงุจุณ ุทุฑุงุญ ุดุฏู ุงุณุช ฺฉู:

- **ุญุฏุงฺฉุซุฑ 60 ูุญุตูู** ุงุฒ ูุฑ ุฏุณุชูโุจูุฏ ุฏุฑ ุฏุชุงุจุณ ูฺฏู ูโุฏุงุฑุฏ
- **ูุฑ 24 ุณุงุนุช** ูุญุตููุงุช ูุฏู ุฑุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูพุงฺฉ ูโฺฉูุฏ
- **ุณุงุฎุชุงุฑ ููุงุด** ุฑุง ุชุบุฑ ููโุฏูุฏ
- **ุนููฺฉุฑุฏ ุณุฑุนโุชุฑ** ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉุด ุฏุชุงุจุณ

## ูฺฺฏโูุง

### ๐ ฺฉุด ุฎูุฏฺฉุงุฑ

- ูุญุตููุงุช ุฏุฑ ุฏุชุงุจุณ MongoDB ุฐุฎุฑู ูโุดููุฏ
- TTL Index ุจุฑุง ุญุฐู ุฎูุฏฺฉุงุฑ ุจุนุฏ ุงุฒ 24 ุณุงุนุช
- ุญุฏุงูู 30 ูุญุตูู ุจุฑุง ูุนุงู ุดุฏู ฺฉุด

### ๐ ูุฏุฑุช ุฏุณุชูโุจูุฏ

- **fashion**: ูุฏ ู ูพูุดุงฺฉ
- **beauty**: ุฒุจุง ู ุขุฑุงุด
- **electronics**: ุงูฺฉุชุฑููฺฉ
- **sports**: ูุฑุฒุด
- **pets**: ุญูุงูุงุช ุฎุงูฺฏ
- **vitamins**: ูุชุงูู ู ุฏุงุฑู
- **other**: ุณุงุฑ

### ๐๏ธ ูุญุฏูุฏุชโูุง

- ุญุฏุงฺฉุซุฑ 60 ูุญุตูู ุฏุฑ ูุฑ ุฏุณุชูโุจูุฏ
- ุญุฐู ุฎูุฏฺฉุงุฑ ูุญุตููุงุช ูุฏู
- ุญูุธ ุฌุฏุฏุชุฑู ูุญุตููุงุช

## API Endpoints

### 1. ุฌุณุชุฌู ูุญุตููุงุช

```
GET /api/shopping?q={query}
```

- ุงุจุชุฏุง ฺฉุด ุฏุชุงุจุณ ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ
- ุงฺฏุฑ ูุญุตููุงุช ฺฉุงู ููุฌูุฏ ุจุงุดุฏุ ุงุฒ ฺฉุด ุจุฑูโฺฏุฑุฏุงูุฏ
- ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุฌุณุชุฌู ุฌุฏุฏ ุงูุฌุงู ูโุฏูุฏ

### 2. ูุฏุฑุช ฺฉุด

```
GET /api/shopping/cache-manager?action={action}
```

**Actions:**

- `stats`: ุขูุงุฑ ฺฉุด
- `cleanup`: ูพุงฺฉ ฺฉุฑุฏู ฺฉุด ูุฏู
- `get-cached&category={category}`: ุฏุฑุงูุช ูุญุตููุงุช ฺฉุด ุดุฏู

### 3. Cron Job

```
GET /api/cron/cleanup-cache?secret={secret}
```

- ูพุงฺฉ ฺฉุฑุฏู ุฎูุฏฺฉุงุฑ ูุญุตููุงุช ูุฏู
- ูุญุฏูุฏ ฺฉุฑุฏู ุชุนุฏุงุฏ ูุญุตููุงุช ุฏุฑ ูุฑ ุฏุณุชู

## ุตูุญุงุช ูุฏุฑุช

### ุตูุญู ูุฏุฑุช ฺฉุด

```
/cache-manager
```

- ููุงุด ุขูุงุฑ ฺฉุด
- ฺฉูุชุฑู ุฏุณุช ฺฉุด
- ูุธุงุฑุช ุจุฑ ุนููฺฉุฑุฏ

## ูุญูู ฺฉุงุฑฺฉุฑุฏ

### 1. ุฌุณุชุฌู ุงููู

```typescript
// ุจุฑุฑุณ ฺฉุด ุฏุชุงุจุณ
const hasCachedProducts = await GoogleShoppingProduct.hasEnoughCachedProducts(
  queryType,
  30
);

if (hasCachedProducts) {
  // ุจุฑฺฏุฑุฏุงูุฏู ูุญุตููุงุช ุงุฒ ฺฉุด
  const cachedProducts = await GoogleShoppingProduct.getCachedProducts(
    queryType,
    60
  );
  return formattedProducts;
}
```

### 2. ุฐุฎุฑู ูุญุตููุงุช ุฌุฏุฏ

```typescript
// ุฐุฎุฑู ุฏุฑ ุฏุชุงุจุณ
const productData = {
  id: product.id,
  title: product.title,
  title_fa: persianTitle,
  price: price.toString(),
  link: storeLink,
  thumbnail: product.thumbnail,
  source: product.source,
  category: queryType,
  createdAt: new Date(),
  expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 ุณุงุนุช
};

await new GoogleShoppingProduct(productData).save();
```

### 3. ูุฏุฑุช ูุญุฏูุฏุชโูุง

```typescript
// ูุญุฏูุฏ ฺฉุฑุฏู ุชุนุฏุงุฏ ูุญุตููุงุช
await GoogleShoppingProduct.limitProductsPerCategory(category, 60);
```

## ูุฒุงุง

### โก ุณุฑุนุช

- ฺฉุงูุด ุฒูุงู ูพุงุณุฎโุฏู
- ฺฉุงูุด ุฏุฑุฎูุงุณุชโูุง API
- ฺฉุด ููุดููุฏ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ

### ๐พ ุจูููโุณุงุฒ ุญุงูุธู

- ุญุฏุงฺฉุซุฑ 60 ูุญุตูู ุฏุฑ ูุฑ ุฏุณุชู
- ุญุฐู ุฎูุฏฺฉุงุฑ ูุญุตููุงุช ูุฏู
- ูุฏุฑุช ุฎูุฏฺฉุงุฑ ูุถุง ุฏุชุงุจุณ

### ๐ ุจูโุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ

- ูุญุตููุงุช ุฌุฏุฏ ุฌุงฺฏุฒู ูุฏูโูุง
- ุญูุธ ุชุงุฒฺฏ ุงุทูุงุนุงุช
- ุนููฺฉุฑุฏ ูุฏุงูู

## ุชูุธูุงุช

### ูุชุบุฑูุง ูุญุท

```env
CRON_SECRET=your_secret_key  # ุจุฑุง cron job
```

### ุชูุธูุงุช TTL

```typescript
// 24 ุณุงุนุช
expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000);
```

### ุชูุธูุงุช ูุญุฏูุฏุช

```typescript
const MAX_PRODUCTS_PER_CATEGORY = 60;
const MIN_PRODUCTS_FOR_CACHE = 30;
```

## ูุธุงุฑุช ู ูุฏุฑุช

### ุขูุงุฑ ฺฉุด

```typescript
const stats = await GoogleShoppingProduct.aggregate([
  {
    $group: {
      _id: "$category",
      count: { $sum: 1 },
      oldestProduct: { $min: "$createdAt" },
      newestProduct: { $max: "$createdAt" },
    },
  },
]);
```

### ูพุงฺฉ ฺฉุฑุฏู ุฏุณุช

```typescript
// ูพุงฺฉ ฺฉุฑุฏู ฺฉุด ูุฏู
await GoogleShoppingProduct.limitProductsPerCategory(category, 60);
```

## Cron Job Setup

ุจุฑุง ุชูุธู cron job ุฎูุฏฺฉุงุฑ:

```bash
# ูุฑ ุณุงุนุช
0 * * * * curl "https://your-domain.com/api/cron/cleanup-cache?secret=your_secret"

# ุง ูุฑ 6 ุณุงุนุช
0 */6 * * * curl "https://your-domain.com/api/cron/cleanup-cache?secret=your_secret"
```

## ูฺฉุงุช ููู

1. **ุณุงุฎุชุงุฑ ููุงุด**: ูฺ ุชุบุฑ ุฏุฑ UI ุงุฌุงุฏ ูุดุฏู
2. **ุนููฺฉุฑุฏ**: ุณุฑุนุช ุฌุณุชุฌู ุจูุจูุฏ ุงูุชู
3. **ุญุงูุธู**: ูุฏุฑุช ุฎูุฏฺฉุงุฑ ูุถุง ุฏุชุงุจุณ
4. **ุชุงุฒฺฏ**: ูุญุตููุงุช ูุฑ 24 ุณุงุนุช ุจูโุฑูุฒุฑุณุงู ูโุดููุฏ
5. **ููุงุณโูพุฐุฑ**: ูุงุจูุช ุงูุฒุงุด ุชุนุฏุงุฏ ุฏุณุชูโุจูุฏโูุง

## ุนุจโุงุจ

### ูุดฺฉู: ูุญุตููุงุช ฺฉุด ููโุดููุฏ

- ุจุฑุฑุณ ุงุชุตุงู ุฏุชุงุจุณ
- ุจุฑุฑุณ ุชุนุฏุงุฏ ูุญุตููุงุช (ุญุฏุงูู 30)
- ุจุฑุฑุณ ุฏุณุชูโุจูุฏ ุตุญุญ

### ูุดฺฉู: ฺฉุด ูพุงฺฉ ููโุดูุฏ

- ุจุฑุฑุณ TTL Index
- ุจุฑุฑุณ cron job
- ุจุฑุฑุณ ุฏุณุชุฑุณโูุง ุฏุชุงุจุณ

### ูุดฺฉู: ุนููฺฉุฑุฏ ฺฉูุฏ

- ุจุฑุฑุณ ุชุนุฏุงุฏ ูุญุตููุงุช ุฏุฑ ูุฑ ุฏุณุชู
- ุจุฑุฑุณ ุงูุฏฺฉุณโูุง ุฏุชุงุจุณ
- ุจุฑุฑุณ ุงุชุตุงู ุดุจฺฉู
